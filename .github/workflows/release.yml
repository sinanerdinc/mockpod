name: Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on version tags (e.g., v1.0.0)

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BUILD_NUMBER=${{ github.run_number }}
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Invalid tag version: $VERSION (expected format: vX.Y.Z)"
            exit 1
          fi
          echo "APP_VERSION=$VERSION" >> $GITHUB_ENV
          echo "APP_BUILD=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

      - name: Generate Xcode Project
        run: xcodegen

      - name: Cache SPM Packages
        uses: actions/cache@v4
        with:
          path: build/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('project.yml') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build App
        # Building in Release mode without code signing identity
        run: |
          xcodebuild -scheme Mockpod \
            -configuration Release \
            -derivedDataPath build \
            MARKETING_VERSION="${{ env.APP_VERSION }}" \
            CURRENT_PROJECT_VERSION="${{ env.APP_BUILD }}" \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_ENTITLEMENTS="" \
            CODE_SIGNING_ALLOWED=NO

      - name: Verify built app version
        run: |
          APP_INFO="build/Build/Products/Release/Mockpod.app/Contents/Info.plist"
          ACTUAL_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$APP_INFO")
          ACTUAL_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" "$APP_INFO")
          echo "Built app version: ${ACTUAL_VERSION} (${ACTUAL_BUILD})"
          if [ "$ACTUAL_VERSION" != "${{ env.APP_VERSION }}" ]; then
            echo "Version mismatch! expected=${{ env.APP_VERSION }}, actual=$ACTUAL_VERSION"
            exit 1
          fi
          if [ "$ACTUAL_BUILD" != "${{ env.APP_BUILD }}" ]; then
            echo "Build number mismatch! expected=${{ env.APP_BUILD }}, actual=$ACTUAL_BUILD"
            exit 1
          fi

      - name: Ad-hoc Sign Binary
        run: |
          codesign --force --deep --sign "-" build/Build/Products/Release/Mockpod.app

      - name: Create DMG
        run: |
          cd build/Build/Products/Release/
          create-dmg \
            --volname "Mockpod Installer" \
            --volicon "Mockpod.app/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Mockpod.app" 200 190 \
            --hide-extension "Mockpod.app" \
            --app-drop-link 600 185 \
            "Mockpod.dmg" \
            "Mockpod.app"

      - name: Archive artifacts
        run: |
          cd build/Build/Products/Release/
          zip -r Mockpod.app.zip Mockpod.app
          echo "SHA256_ZIP=$(shasum -a 256 Mockpod.app.zip | awk '{print $1}')" >> $GITHUB_ENV
          echo "SHA256_DMG=$(shasum -a 256 Mockpod.dmg | awk '{print $1}')" >> $GITHUB_ENV

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          generate_release_notes: true
          files: |
            build/Build/Products/Release/Mockpod.app.zip
            build/Build/Products/Release/Mockpod.dmg
          body: |

            ## Installation

            1. Download Mockpod.dmg below
            2. Open the DMG and drag Mockpod to Applications
            3. Since the app is not notarized, macOS may block it on first launch. Run the following command in Terminal to fix this:

            ```
            xattr -cr /Applications/Mockpod.app
            ```

            Then open Mockpod normally.

            Or install via Homebrew:

            ```
            brew install --cask sinanerdinc/tap/mockpod
            ```
            
            Note: To update Mockpod to the newest version in the future, simply run:

            ```
            brew update && brew upgrade --cask mockpod
            ```
            
            ---
            
            ## Checksums (SHA256)
            
            ### Mockpod.dmg
            ```
            ${{ env.SHA256_DMG }}
            ```
            
            ### Mockpod.app.zip
            ```
            ${{ env.SHA256_ZIP }}
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Homebrew Cask
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: mockpod
          formula-path: Casks/mockpod.rb
          homebrew-tap: sinanerdinc/homebrew-tap
          download-url: https://github.com/sinanerdinc/mockpod/releases/download/${{ github.ref_name }}/Mockpod.dmg
        env:
          COMMITTER_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
