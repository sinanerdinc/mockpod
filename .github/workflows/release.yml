name: Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger on version tags (e.g., v1.0.0)

jobs:
  build:
    name: Build macOS App
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Tools
        run: |
          brew install xcodegen
          brew install create-dmg

      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          BUILD_NUMBER=${{ github.run_number }}
          sed -i '' "s/MARKETING_VERSION: \".*\"/MARKETING_VERSION: \"$VERSION\"/" project.yml
          sed -i '' "s/CURRENT_PROJECT_VERSION: .*/CURRENT_PROJECT_VERSION: $BUILD_NUMBER/" project.yml
          echo "Version: $VERSION, Build: $BUILD_NUMBER"

      - name: Generate Xcode Project
        run: xcodegen

      - name: Cache SPM Packages
        uses: actions/cache@v4
        with:
          path: build/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('project.yml') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build App
        # Building in Release mode without code signing identity
        run: |
          xcodebuild -scheme Mockpod \
            -configuration Release \
            -derivedDataPath build \
            clean build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_ENTITLEMENTS="" \
            CODE_SIGNING_ALLOWED=NO

      - name: Ad-hoc Sign Binary
        run: |
          codesign --force --deep --sign "-" build/Build/Products/Release/Mockpod.app

      - name: Create DMG
        run: |
          cd build/Build/Products/Release/
          create-dmg \
            --volname "Mockpod Installer" \
            --volicon "Mockpod.app/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Mockpod.app" 200 190 \
            --hide-extension "Mockpod.app" \
            --app-drop-link 600 185 \
            "Mockpod.dmg" \
            "Mockpod.app"

      - name: Archive artifacts
        run: |
          cd build/Build/Products/Release/
          zip -r Mockpod.app.zip Mockpod.app
          echo "SHA256_ZIP=$(shasum -a 256 Mockpod.app.zip | awk '{print $1}')" >> $GITHUB_ENV
          echo "SHA256_DMG=$(shasum -a 256 Mockpod.dmg | awk '{print $1}')" >> $GITHUB_ENV

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            build/Build/Products/Release/Mockpod.app.zip
            build/Build/Products/Release/Mockpod.dmg
          body: |
            ## Release Notes
            
            *(Add your release notes here)*
            
            ## Checksums (SHA256)
            
            ### Mockpod.dmg
            ```
            ${{ env.SHA256_DMG }}
            ```
            
            ### Mockpod.app.zip
            ```
            ${{ env.SHA256_ZIP }}
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
